watch_file flake.nix
watch_file flake.lock
mkdir -p "$(direnv_layout_dir)"
eval "$(nix print-dev-env --profile "$(direnv_layout_dir)/flake-profile")"

test -s ".envrc-local" && source ".envrc-local"

ROLE="${ROLE:-developer}"

if vault token lookup &> /dev/null; then
  echo "Obtaining and exporting Consul and Nomad $ROLE tokens"
  CONSUL_HTTP_TOKEN="$(vault read -field token consul/creds/${ROLE})"
  NOMAD_TOKEN="$(vault read -field secret_id nomad/creds/${ROLE})"
  export CONSUL_HTTP_TOKEN
  export NOMAD_TOKEN
fi
